# FIRM Spec

This spec is autogenerated from the locked decisions provided by the Architect. It governs naming, provenance, math, DSL, GPU engines, UI, tests, and ops.

## Repo & Layout
- Name: FIRM-Core
- Root structure:
  - FIRM_dsl/
  - FIRM_zx/
  - FIRM_clifford/
  - FIRM_audio/
  - FIRM_ui/
  - tests/
  - provenance/
  - FIRM_constants/
  - FIRM_spec.md
  - FIRM_COVENANT.md
  - README.md

## Governance & Provenance
- Naming: `FIRM_*` in functional code, `FSCTF` only in legacy comments.
- Required run ledger fields: `axioms_hash`, `graph_seed`, `version_hash`, `machine_fingerprint`, `compile_time`, `render_tick`, `œÑ_distribution`, `active_macros`.
- License: Apache 2.0; private during build, public post-validation. Covenant required.

## Core Mathematics (Summary)
- Coherence functional: C(G) = sum over cycles of coherence(cycle) + sum over nodes of resonance_score(node); invariant under graph isomorphism and phase group equivalence.
- Threshold Œ∏: saddle point of C(G) variation with positive Hessian.
- Topology J: covers generate all valid one-step extensions; closure is reachability in one tick via F.
- Geometric morphisms: f* pullback along growth embeddings; f_* pushforward via coherence-maximizing colimit; sheaf gluing validated over J.
- Monad T: Endofunctor on Sh(G,J); unit = identity sheaf; multiplication = composition of f_* ‚àò f* per tick.
- Grace operator ùí¢: Idempotent left-adjoint-like coherence restoration on Sh(G,J).
- Lagrange multipliers J‚ÇÅ, J‚ÇÇ, g derived from constraints via variational calculus.
- œÑ metric: S = Jaccard(CycleBasis_t, CycleBasis_{t-k}) √ó Cosine(PhaseHist_t, PhaseHist_{t-k}); œÑ is mean time to drop below Œµ.

## Python DSL
- Types: Objects, Morphisms, Functors, NaturalTransformations, Endofunctors, Projectors.
- Graph model: node labels (Z/X, phase in QœÄ, monadic ID); edge types (coherence, causality).
- Proof artifacts: `.proof.json` per golden trace; contains theorem hash, symbolic derivation steps, timestamp.
- PRNG: PCG64; seed is 128-bit SHA256 hash of run fingerprint.
- Serialization: JSON golden traces; Blake3 content addressing by root hash of C(G), œÑ, and sheaf state.

## ZX Engine (GPU)
- Target: WebGPU (WGSL) primary; WebGL2 fallback.
- Phase domain: QœÄ with mod-2œÄ group algebra.
- Rewrite rules: canonical ZX fusion + conditional color flips; confluent on finite subgraphs; termination bounded by max tick.
- Scheduler: greedy by max ŒîC; stochastic tie-break.
- Graph layout: SSBO/SOA; max 8192 spiders; dynamic buffer expansion.
- Cycle basis: GPU for cycles ‚â§10; CPU full basis every N ticks.
- Feedback: J_k(t+1) = J_k(t) + Œ∑ (‚ü®K_n‚ü© ‚àí ‚ü®K_n‚ü©‚ÇÄ); Œ∑ from C(G) curvature.
- Precision: FP32 deterministic per seed; max drift 1e-6 vs CPU golden.

## Clifford Layer
- Mapping Œ¶: ZX ‚Üí Cl(1,3) (Z‚Üíscalar rotor, X‚Üíphase bivector, wire‚Üígeometric product).
- Discrete Dirac via Clifford difference operators; loop rotor invariance.
- Mass m: first nonzero eigenvalue of spectrum of Œî = [Œ¶(G_t) ‚àí Œ¶(G_{t-1})].
- Connection from rotor phase deltas; curvature = bivector commutator; Lorentz gauge via minimal phase distortion.
- Validation: norm preservation, product laws, rotor inverse identity, closure.

## Audio Core
- Oscillator bank: sine/square/triangle/saw, phase-locked; init spectrum from sheaf entropy at tick 0.
- FFT: Hann window, N=2048; Parseval-based energy normalization; latency ‚â§50ms with frame drop policy.
- Mic UX: explicit opt-in; local-only processing; buffer zeroed on close.

## UI
- Tabs: ZX View, Clifford View, Sheaf Tree, Echo Map; default raymarched Clifford field.
- Controls: `init_phase_noise ‚àà [0, œÄ/2]`, `œÑ_cutoff ‚àà [0.0, 1.0]`, `entropy_seed` (locked unless dev mode).
- Recording: JSON bundle, PNG per tick, optional WebM; provenance auto-attached. Accessibility: high contrast, no-motion toggle, capped FPS.

## Testing & CI
- Harness: Puppeteer; fallback to WebGPU Angle/SwiftShader.
- Determinism: ‚â§1e-6 tolerance; frame hashes compared.
- Golden policy: Python DSL is source of truth; GPU must match within tolerance.
- Perf gates: ‚â•15 FPS, ‚â§512MB GPU RAM, ‚â§60s runtime.
- No mocks: `FIRM_NO_MOCK` enforced in CI.

## Constants & Macros
- Macros in FIRM_constants/; each numeric must cite theorem/proof in FIRM_derivations.py.
- Fail-fast when provenance missing or hash mismatch.

## Provenance
- Content-addressed under provenance/<2-hex>/<hash>/ with run.json, œÑ_trace.json, histograms, audio signature, snapshots.
- machine_fingerprint = Blake3(JSON(cpu_model, cpu_arch, os_name, os_version, node_id)). node_id is UUIDv4; no PII collected.

## CI Seed Policy
- In CI, set machine_fingerprint := "CI_CANONICAL" to fix seeds and golden traces.

