## FIRM-Core Architecture Map

This document maps the entire codebase: modules, responsibilities, data flow, and test coverage. All descriptions reflect current implementation status with no hidden behavior or empirical tuning.

### Top-level
- `README.md`: Project overview, architecture, build and test commands.
- `FIRM_spec.md`: Autogenerated governing spec. Naming, math, engines, UI, tests, ops.
- `FIRM_COVENANT.md`: Contributor ethics and license clause.
- `pyproject.toml`: Python package metadata, tooling, pytest config.
- `Makefile`: Common tasks (install, test, coverage, lint, format, deploy-check).
- `DEPLOYMENT.md`: Deployment guidance (present if needed by ops).
- `run_automated_test.py`: Entrypoint for UI automation (headless).

### Core Domains

1) DSL: `FIRM_dsl/`
- `core.py`: Types for ZX-like objects and morphisms; Qπ phase normalization; validators; integer-only phase ops; utilities: `normalize_phase_qpi`, `add_phases_qpi`, `phase_to_bin_index`, `lcm_many`, `validate_object_g`, `make_node_label`.
- `sheaf.py`: Types for `Cover`, `Presheaf`, `Sheaf` with abstract `restrict`/`glue`.
- `monad.py`: Geometric morphisms scaffolding `f_pullback`, `f_pushforward` (identity stubs), `MonadT`, `TAlgebra` protocol, `GraceOperatorStructure` structural validators and `apply_grace_operator` using pull-push.
- `coherence.py`: Coherence functional C(G), cycle basis signature, phase histogram signature, similarity S, θ saddle derivation structure. Implements:
  - `compute_cycle_basis_signature` (DFS fundamental cycles, canonicalized)
  - `compute_phase_histogram_signature` (binning derived from Qπ)
  - `similarity_S` (Jaccard × cosine)
  - `compute_coherence` (cycle and node terms; arithmetic uses floats but no tuning)
  - `derive_minimal_qpi_bins`
  - `derive_theta_saddle_point` (structure-based estimate relative to max coherence)
- `provenance.py`: `RunLedger` schema; BLAKE3 hashing via vendor; content addressing helpers; bundle composition (pure, no IO).
- `provenance_writer.py`: Filesystem writer with structure validation, integrity verification, manifest creation. Hash function is dependency-injected.
- `blake3_vendor.py`: Test/deterministic hashing hooks (used in tests).
- `__init__.py`: Export list.

2) Constants: `FIRM_constants/`
- `FIRM_derivations.py`: Centralized, proof-tagged derivations. Implemented: `derive_phase_unit` (π/4), `derive_echo_threshold` (1/e), `derive_phase_unit_rational` (LCM-based), Hessian/saddle structure validators.
- `generate_header.py`: Renders `FIRM_constants.gen.h` from `DerivationResult`. Includes `build_constants_from_derivations` for rational unit generation and `rational_to_float`.
- `FIRM_constants.h`: Stub header enforcing generated inclusion.
- `FIRM_constants.gen.h`: Example generated header (currently contains `FIRM_PHASE_UNIT`).

3) ZX Engine: `FIRM_zx/`
- `FIRM_ZX.wgsl`: WGSL compute shader stub with `Params`/`Spider` layouts.
- `host_layout.py`: Exact 16-byte `SpiderPacked` struct with pack/unpack.
- `host_params.py`: `Params` struct pack/validate (little-endian <IIII).
- `host_bindings.py`: Buffer assembly, size computation.
- `rules.py`: Rewrite precondition checks; `CoherenceDeltaScaffold` providing structural ΔC computations and raising for scheduling.
- `README.md`: Layout notes.

4) Clifford Layer: `FIRM_clifford/`
- `interface.py`: Implements `phi_zx_to_clifford` producing 16-component normalized field; structural validators for discrete Dirac mass and mapping; raising stubs for unimplemented heavy ops.
- `mapping.py`: Raising stubs for alternative implementations (not used yet).

5) Audio: `FIRM_audio/`
- `derivations.py`: Parseval normalization derivation for Hann window; normalized audio coherence computation.
- `index.js`: Web Audio utilities (oscillator bank, analyser setup, compute energy, coherent feedback loop). Requires explicit normalization input from Python derivations.

6) UI (WebGL/WebGPU): `FIRM_ui/`
- `index.html`: Tabs UI (Clifford/ZX/Sheaf/Echo), canvas, a11y toggles, modular JS bootstrap.
- `shader_validator.py`: Syntax-only GLSL/WGSL validator used by tests.
- `shader_runtime.js`: WebGL2 runtime (compilation/link/validate, buffers) and WebGPU runtime scaffold.
- `raymarching.js`: `RaymarchingValidator` and `RaymarchingPipeline` generation with theory-compliant shaders (vertex/fragment) sampling Clifford field texture; uniforms defined explicitly.
- `renderer.js`: `FIRMRenderer` ties runtime and pipeline; creates textures from Clifford fields; computes matrices; renders fullscreen quad; includes field generators for each view (used until full engine integration).
- `main.js`: UI controller, renderer bootstrap, analog engine creation, evolution loop that wires audio coherence → ZX evolution stub → field generation → camera adaptation and debug overlay.
- Additional helpers: `debug_status.js`, `theory_iteration.js`, `zx_evolution.js`, camera/emergency fixes, shaders (`final_shader_fix.glsl`, `emergency_shader.glsl`), etc.

7) Provenance Store: `provenance/`
- `run.schema.json`: JSON schema for `run.json` (required fields).
- `README.md`: Bundle layout (content-addressed pathing and artifacts list).

8) Tests: `tests/`
- `test_structure.py`: Repository skeleton, unimplemented guards, Qπ arithmetic utilities, constants derivations, header rendering, provenance hashing, ZX host layout/params, ZX rules, Clifford mapping and validators, shader validator, raymarching validator, provenance writer, audio Parseval derivations.
- `test_integration.py`: End-to-end pipelines (graph → coherence → θ → constants; ZX→Clifford→mass; audio→coherence; provenance write/verify; UI shader pipeline integration).
- `test_rendering.py`: Field-to-texture, camera math checks, raymarching pipeline integration and parameter constraints.
- `test_benchmarks.py`: Performance benchmarks covering coherence, cycles, Clifford mapping, ZX ΔC, provenance bundle.
- `test_webgl_automated.py`: Selenium-based headless end-to-end UI automation including server spin-up, logs scraping, metrics and screenshots.

### Data Flow (theory-first)
- ZX Graph (`FIRM_dsl.core.ObjectG`) → Coherence C(G) and cycle/phase signatures (`FIRM_dsl.coherence`).
- θ derived structurally from C(G) scale (`derive_theta_saddle_point`).
- ZX → Clifford: `FIRM_clifford.interface.phi_zx_to_clifford` → 16-component field.
- Field → UI: `FIRM_ui.renderer.FIRMRenderer` packs components into 4×1 RGBA32F texture; raymarching shader samples components and renders.
- Audio: `FIRM_audio.derivations` derive Parseval normalization; `FIRM_audio/index.js` or inline analog engine in `main.js` provides real-time coherence driving evolution.
- Provenance: `FIRM_dsl.provenance` encodes ledger; `provenance_writer` writes bundles with content addressing; tests validate determinism.

### Invariants and Policy
- No empirical tuning. Arithmetic uses integers where specified (Qπ). Any floats are purely for deterministic computation without tuning.
- Unimplemented functionality raises `NotImplementedError` or explicit errors; no silent fallbacks.
- Constants/macros only via derivations with proof IDs; header generation enforces `FIRM_` prefix.
- UI defaults to Clifford raymarched view; shader sources validated by tests.

### Cross-module Dependencies (selected)
- DSL → Constants: tests use constants derivations; header generator is independent.
- ZX host layout/params ↔ WGSL `Spider`/`Params` layout parity (exact 16-byte records; <IIII packing).
- Clifford interface depends on DSL types and math; UI depends on renderer + raymarching pipeline.
- Provenance modules share hashing via `blake3_vendor` (injected function for tests).

### Notable Raising Boundaries
- `FIRM_dsl.coherence.compute_identity_echo_time_tau`: Not implemented.
- `FIRM_zx.rules.CoherenceDeltaScaffold.schedule_rewrites_by_delta_c`: Not implemented.
- `FIRM_clifford.mapping` functions: Raising stubs; prefer `interface.py` implementation.

### Build/Test Entrypoints
- Python: `make test` / `pytest -v` (strict config).
- Coverage: `make test-coverage`.
- Lint/format: `make lint`, `make format`, `make check-format`.
- Constants generation: `make generate-constants` (prints derived values; header render when values present).
- UI automation: `tests/test_webgl_automated.py` (requires Chrome + Selenium).

### Current Gaps vs Spec
- τ computation pending.
- ZX rewrite scheduling pending.
- WebGPU compute pipeline is scaffold-only; main path uses WebGL2.
- Some UI modules named *fix*/*emergency* are for scaffolding and debugging; they should be replaced once derivations land.

### Notes for Future Derivation Work
- Promote integer-only phase computations deep into coherence where possible; isolate float projections to display-only code.
- Move inline analog engine from `main.js` into `FIRM_audio/index.js` wired through proven normalization.
- Replace placeholder manifold SDF in fragment shader with field-derived distance informed by Clifford algebra, once mapping derivations are locked.


